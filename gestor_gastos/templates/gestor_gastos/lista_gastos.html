{% extends 'gestor_gastos/base.html' %}
{% load l10n %}

{% block title %}Resumen de Mis Gastos{% endblock %}

{% block content %}
    <header class="seccion-titulo">
        <h2>Resumen de Mis Gastos</h2>
        <p>Aqu√≠ puedes ver un an√°lisis completo de todos los gastos que has registrado.</p>
    </header>

    {# Formulario de Filtro de Mes/A√±o #}
    <section class="filtro-gastos-container" aria-labelledby="titulo-filtros">
        <h3 id="titulo-filtros" class="sr-only">Filtrar gastos por per√≠odo</h3>
        <form method="get" action="{% url 'lista_gastos' %}" aria-label="Formulario de filtros de gastos">
            <div class="form-group">
                <label for="mes">üìÖ Mes:</label>
                <select name="mes" id="mes" aria-describedby="mes-help">
                    {% for num, nombre in nombres_meses %}
                        <option value="{{ num }}" {% if num|stringformat:"s" == mes_seleccionado %}selected{% endif %}>
                            {{ nombre }}
                        </option>
                    {% endfor %}
                </select>
                <div id="mes-help" class="sr-only">Selecciona el mes para filtrar los gastos</div>
            </div>

            <div class="form-group">
                <label for="anio">üóìÔ∏è A√±o:</label>
                <select name="anio" id="anio" aria-describedby="anio-help">
                    {% for anio in rango_anios %}
                        <option value="{{ anio }}" {% if anio|stringformat:"s" == anio_seleccionado %}selected{% endif %}>
                            {{ anio }}
                        </option>
                    {% endfor %}
                </select>
                <div id="anio-help" class="sr-only">Selecciona el a√±o para filtrar los gastos</div>
            </div>

            <button type="submit" class="boton-filtro" aria-label="Aplicar filtros seleccionados">
                üîç Filtrar
            </button>
        </form>
    </section>

    {# Resumen Total Gastado #}
    <section class="resumen-total" role="region" aria-labelledby="titulo-total">
        <h3 id="titulo-total">Total Gastado en 
            {% for num, nombre in nombres_meses %}
                {% if num|stringformat:"s" == mes_seleccionado %}{{ nombre }}{% endif %}
            {% endfor %} 
            de {{ anio_seleccionado }}:
        </h3>
        <p class="monto-total" aria-label="Monto total gastado: {{ total_mes }} pesos">
            $ {{ total_mes }}
        </p>
    </section>

    {# Secci√≥n de An√°lisis: Desglose y Gr√°fico #}
    <section class="seccion-analisis" role="region" aria-labelledby="titulo-analisis">
        <h3 id="titulo-analisis" class="sr-only">An√°lisis de gastos por categor√≠a</h3>
        
        <div class="desglose-categorias">
            <h4>üìã Desglose por Categor√≠a</h4>
            {% if gastos_por_categoria %}
                <ul role="list" aria-label="Lista de gastos por categor√≠a">
                    {% for desglose in gastos_por_categoria %}
                        <li role="listitem">
                            <span>{{ desglose.categoria__nombre }}</span>
                            <span class="monto-categoria" 
                                  aria-label="Total en {{ desglose.categoria__nombre }}: {{ desglose.total }} pesos">
                                $ {{ desglose.total }}
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="no-data" role="alert">
                    <p>üìù No hay gastos registrados para este mes y a√±o en ninguna categor√≠a.</p>
                </div>
            {% endif %}
        </div>
        
        <div class="contenedor-grafico">
            <h4>Distribuci√≥n Gr√°fica</h4>
            {% if data_grafico|length > 2 %}
                <div style="position: relative; height: 400px; width: 100%;" 
                     role="img" 
                     aria-label="Gr√°fico circular mostrando la distribuci√≥n de gastos por categor√≠a">
                    <canvas id="gastosChart"></canvas>
                </div>
            {% else %}
                <div class="no-chart" role="alert">
                    <p>No hay datos suficientes para generar el gr√°fico de distribuci√≥n.</p>
                </div>
            {% endif %}
        </div>
    </section>

    <hr class="separador" aria-hidden="true">
    
    <section class="seccion-detalle" role="region" aria-labelledby="titulo-detalle">
        <h3 id="titulo-detalle">üìã Detalle de Todos los Gastos ({{ gastos|length }} Registros)</h3>
        
        {% if gastos %}
            <div class="tabla-container">
                <table class="tabla-gastos" role="table" aria-label="Tabla detallada de gastos registrados">
                    <thead>
                        <tr role="row">
                            <th role="columnheader" scope="col">Fecha</th>
                            <th role="columnheader" scope="col">Categor√≠a</th>
                            <th role="columnheader" scope="col">Descripci√≥n</th>
                            <th role="columnheader" scope="col">üí∞ Monto</th>
                            <th role="columnheader" scope="col" style="width: 150px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for gasto in gastos %}
                            <tr role="row">
                                <td role="cell" data-label="Fecha">{{ gasto.fecha|date:"d/m/Y" }}</td>
                                <td role="cell" data-label="Categor√≠a">{{ gasto.categoria.nombre }}</td>
                                <td role="cell" data-label="Descripci√≥n">{{ gasto.descripcion|default:"Sin descripci√≥n" }}</td>
                                <td role="cell" data-label="Monto" class="monto-gasto">$ {{ gasto.monto }}</td>
                                <td role="cell" class="acciones-gasto">
                                    <a href="{% url 'modificar_gasto' gasto_id=gasto.id %}" 
                                       class="btn-accion-sm btn-modificar"
                                       aria-label="Modificar gasto de {{ gasto.categoria.nombre }} por {{ gasto.monto }} pesos"
                                       title="Modificar este gasto">
                                        Modificar
                                    </a>
                                    <a href="{% url 'eliminar_gasto' gasto_id=gasto.id %}" 
                                       class="btn-accion-sm btn-eliminar"
                                       aria-label="Eliminar gasto de {{ gasto.categoria.nombre }} por {{ gasto.monto }} pesos"
                                       title="Eliminar este gasto">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr role="row">
                                <td role="cell" colspan="5" style="text-align: center; padding: 2rem;">
                                    <div role="alert">
                                        üì≠ No hay gastos registrados para el mes y a√±o seleccionado.
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="no-gastos" role="alert">
                <p>üì≠ No hay gastos registrados para el mes y a√±o seleccionado.</p>
            </div>
        {% endif %}
    </section>

    <section class="acciones-lista" role="navigation" aria-label="Navegaci√≥n de acciones">
        <a href="{% url 'principal_gastos' %}" 
           class="link-accion"
           aria-label="Volver a la p√°gina principal para registrar nuevos gastos">
            ‚Üê üè† Volver a la p√°gina principal
        </a>
    </section>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvasElement = document.getElementById('gastosChart');
            
            if (canvasElement) {
                const ctx = canvasElement.getContext('2d');
                
                // CAMBIO PRINCIPAL: Recibir los datos directamente desde Django sin json_script
                const chartNombresCategorias = {{ labels_grafico|safe }};
                const chartMontosCategorias = {{ data_grafico|safe }};
                
                console.log('Labels:', chartNombresCategorias);
                console.log('Data:', chartMontosCategorias);
                
                // Verificar que los datos sean arrays v√°lidos
                if (Array.isArray(chartNombresCategorias) && Array.isArray(chartMontosCategorias) && 
                    chartNombresCategorias.length > 0 && chartMontosCategorias.length > 0) {
                    
                    // Colores para el gr√°fico
                    const backgroundColors = [
                        '#63B8B8', '#E7625F', '#4A6D7C', '#FFD166', '#8DCCAD',
                        '#C7CEEA', '#F7B538', '#76A08A', '#B0D8A4', '#F2EFEA'
                    ];
                    
                    try {
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: chartNombresCategorias,
                                datasets: [{
                                    label: 'Gasto por Categor√≠a',
                                    data: chartMontosCategorias,
                                    backgroundColor: backgroundColors.slice(0, chartNombresCategorias.length),
                                    borderColor: backgroundColors.slice(0, chartNombresCategorias.length).map(color => color + 'CC'),
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                        labels: {
                                            font: { size: 12 },
                                            padding: 15
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed !== null) {
                                                    // Formatear como peso chileno
                                                    const value = context.parsed;
                                                    const formatted = new Intl.NumberFormat('es-CL', {
                                                        style: 'currency',
                                                        currency: 'CLP',
                                                        minimumFractionDigits: 0,
                                                        maximumFractionDigits: 0
                                                    }).format(value);
                                                    label += formatted;
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                layout: {
                                    padding: 20
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error creating chart:', error);
                        document.getElementById('gastosChart').parentElement.innerHTML = 
                            '<p>Error al cargar el gr√°fico. Revisa la consola para m√°s detalles.</p>';
                    }
                } else {
                    console.log('No hay datos v√°lidos para el gr√°fico');
                    document.getElementById('gastosChart').parentElement.innerHTML = 
                        '<p>No hay datos suficientes para generar el gr√°fico.</p>';
                }
            }
        });
    </script>
{% endblock %}